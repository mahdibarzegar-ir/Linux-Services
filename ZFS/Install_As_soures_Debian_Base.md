### کامپایل و نصب ZFS از سورس در Debian

برای کامپایل و نصب ZFS از سورس در Debian، باید کد منبع **ZFS on Linux** (ZoL) را دانلود، کامپایل و سپس نصب کنید. این فرآیند نسبت به نصب از بسته‌های آماده پیچیده‌تر است، اما به شما امکان می‌دهد کنترل کامل روی نسخه ZFS داشته باشید و تغییرات سفارشی را اعمال کنید.

---
### مرحله ۱: نصب پیش‌نیازها
قبل از کامپایل ZFS، باید ابزارهای لازم و وابستگی‌های مورد نیاز را نصب کنید. برای این کار، دستورات زیر را اجرا کنید:

```bash
sudo apt update
sudo apt install build-essential autoconf libtool gawk alien fakeroot linux-headers-$(uname -r) zlib1g-dev uuid-dev libblkid-dev libselinux-dev libssl-dev parted lsscsi wget git 
```

این بسته‌ها شامل ابزارهای ضروری برای کامپایل، مدیریت وابستگی‌ها، و کار با هدرهای کرنل هستند.

---
### مرحله ۲: دریافت کد منبع ZFS
برای دانلود آخرین نسخه ZFS از مخزن رسمی **ZFS on Linux** در GitHub، از دستورات زیر استفاده کنید:

```bash
git clone https://github.com/openzfs/zfs.git
cd zfs
```

اگر بخواهید نسخه خاصی را دانلود کنید، می‌توانید از صفحه **انتشارهای ZFS** در [GitHub](https://github.com/openzfs/zfs/releases) استفاده کرده و نسخه مورد نظر را انتخاب کنید. به عنوان مثال:

```bash
git checkout tags/zfs-2.1.0
```

---
### مرحله ۳: تنظیمات اولیه و کامپایل ZFS

#### ۱. آماده‌سازی محیط کامپایل

ZFS از `autogen.sh` برای تنظیم سیستم ساخت استفاده می‌کند. ابتدا این ابزار را اجرا کنید:

```bash
./autogen.sh
```

#### ۲. تنظیمات کامپایل

بعد از اجرای `autogen.sh`، باید ZFS را برای کامپایل پیکربندی کنید. برای تنظیمات پیش‌فرض از دستور زیر استفاده کنید:

```bash
./configure
```
* پیشنهاد میشه از روش زیر استفاده کنید که حتما نسخه ی منطبق با کرنل شما نصب شود:

```bash
./configure --with-linux=/lib/modules/$(uname -r)/build
```

#### ۳. کامپایل ZFS

برای شروع فرآیند کامپایل، دستور زیر را اجرا کنید:

```bash
make -j$(nproc)
```

(`nproc` تعداد هسته‌های پردازشی سیستم شما را مشخص کرده و کامپایل را سریع‌تر می‌کند.)

#### ۴. نصب ZFS

پس از کامپایل موفقیت‌آمیز، برای نصب ZFS از دستور زیر استفاده کنید:

```bash
sudo make install
```

---
### مرحله ۴: بارگذاری ماژول کرنل ZFS

پس از نصب، باید ماژول ZFS را در کرنل بارگذاری کنید:

```bash
sudo depmod -a

sudo modprobe zfs
```

برای اطمینان از اینکه ماژول ZFS به درستی بارگذاری شده است، دستور زیر را اجرا کنید:

```bash
lsmod | grep zfs
```

اگر خروجی این دستور شامل `zfs` بود، یعنی ماژول با موفقیت بارگذاری شده است.

---
### مرحله ۵: فعال‌سازی سرویس‌های ZFS


#### باینری های زیر را باید به مسیر bashrc اضافه کنیم:



بررسی کنید که باینری‌های ZFS در کجا نصب شده‌اند. اگر مسیر نصب را نمی‌دانید، می‌توانید به‌طور معمول در `/usr/local/bin` یا `/opt` باشند. به‌طور مثال:
   ```bash
   sudo find / -name "zfs"
   ```

در دبیان باینری `zfs` در مسیر `/usr/local/sbin/zfs` نصب شده است. بنابراین، باید این مسیر را به متغیر محیطی `PATH` اضافه کنید تا سیستم بتواند آن را شناسایی کند.

برای این کار، مراحل زیر را دنبال کنید:

#### 1. مسیر `/usr/local/sbin` را به `PATH` اضافه کنید:
   ```bash
   echo 'export PATH=$PATH:/usr/local/sbin' >> ~/.bashrc
   ```

#### 2. سپس فایل `~/.bashrc` را بارگذاری کنید:
   ```bash
   source ~/.bashrc
   ```
---
### بررسی کتابخانه‌ libzfs.so.6:

#### 1. **مطمئن شوید که کتابخانه‌ها در مسیر درست قرار دارند:**
   ابتدا بررسی کنید که کتابخانه `libzfs.so.6` در سیستم شما وجود دارد:
   ```bash
   sudo find / -name "libzfs.so.6"
   ```

   اگر این فایل در سیستم شما وجود دارد، مطمئن شوید که مسیر آن در متغیر محیطی `LD_LIBRARY_PATH` قرار دارد.

#### 2. **اضافه کردن مسیر کتابخانه به `LD_LIBRARY_PATH`:**
   اگر فایل `libzfs.so.6` را پیدا کردید، مسیر آن را به متغیر `LD_LIBRARY_PATH` اضافه کنید. به‌طور معمول، این کتابخانه‌ها در مسیرهایی مانند `/usr/local/lib` یا `/usr/local/lib64` قرار دارند.

   به‌عنوان مثال، اگر مسیر کتابخانه `/usr/local/lib` است، دستور زیر را اجرا کنید:
   ```bash
   echo 'export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/lib' >> ~/.bashrc
   ```

   سپس فایل `~/.bashrc` را بارگذاری کنید:
   ```bash
   source ~/.bashrc
   ```
---
#### 3. **بازخوانی پیکربندی `ldconfig`:**
   اگر کتابخانه‌ها در مسیرهای استاندارد قرار دارند، می‌توانید از دستور `ldconfig` برای به‌روز رسانی کش کتابخانه‌های اشتراکی استفاده کنید:
   ```bash
   sudo ldconfig
   ```
---

#### فعال سازی سرویس های مورد نیاز برای راه اندازی خودکار:
برای اطمینان از اینکه ZFS در راه‌اندازی سیستم به‌طور خودکار اجرا می‌شود، سرویس‌های زیر را فعال کنید:

```bash
sudo systemctl enable zfs-import-cache
sudo systemctl enable zfs-import-scan
sudo systemctl enable zfs-mount
sudo systemctl enable zfs.target
```

---
### مرحله ۶: بررسی نصب

برای بررسی نصب موفقیت‌آمیز ZFS، نسخه آن را چک کنید:

```bash
zfs version
```

---
### مرحله ۷: ایجاد و مدیریت استخرهای ZFS

#### ۱. ایجاد یک استخر جدید

برای ایجاد یک استخر (Pool) در ZFS، از دستور زیر استفاده کنید (به جای `/dev/sdb`، دیسک موردنظر خود را قرار دهید):

```bash
sudo zpool create mypool /dev/sdb
```

#### ۲. ایجاد یک فایل‌سیستم ZFS

```bash
sudo zfs create mypool/mydata
```

#### ۳. بررسی و تغییر مسیر Mount

ZFS به‌طور خودکار فایل‌سیستم را Mount می‌کند، اما می‌توانید مسیر آن را بررسی یا تغییر دهید:

```bash
sudo zfs get mountpoint mypool/mydata
```

برای تغییر مسیر Mount:

```bash
sudo zfs set mountpoint=/mnt/mydata mypool/mydata
```

#### ۴. Unmount و Mount دوباره فایل‌سیستم

```bash
sudo zfs unmount mypool/mydata
sudo zfs mount mypool/mydata
```

---
### مرحله ۸: مدیریت ZFS پس از بروزرسانی کرنل

بعد از بروزرسانی کرنل، باید ماژول‌های ZFS را دوباره کامپایل کنید:

```bash
cd /path/to/zfs/source
sudo make
sudo make install
```

---
### مرحله ۹: پاک‌سازی (اختیاری)

اگر دیگر به کد منبع ZFS نیاز ندارید، می‌توانید آن را حذف کنید:

```bash
cd ..
rm -rf zfs
```

---
### نتیجه‌گیری

کامپایل ZFS از سورس روی اوبونتو به شما این امکان را می‌دهد که نسخه خاصی از ZFS را استفاده کنید و تنظیمات سفارشی خود را اعمال کنید. این روش انعطاف‌پذیری بیشتری نسبت به نصب از مخازن دارد اما نیازمند نگهداری و بروزرسانی‌های منظم، به‌ویژه پس از تغییر نسخه کرنل، است.
